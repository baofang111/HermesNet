## 设计目标
一款很多人都在用的 IM 系统

### 指标假设
1、DAU 5亿+，收发消息 P99 200ms 以下， QPS 日平均 500W， 峰值 750W
2、假设 每人每天 100 条消息，每条消息 10KB， 则每日存储增长约为 4.5PB

### 实现功能
1、添加好友 、 假如群聊 、 退出群聊
2、单聊/群聊/万人群聊 的 【在线、离线、历史】 消息多端同步
3、消息回执/已读，未读数/撤销 等

### 服务划分
> 领域驱动设计

#### 接入层
* 调度
* 连接
* 状态
* 路由

对于接入层，可以将其要解决的问题分为 四个 部分：<br/>
  1、获得最佳 ip 地址，使得客户端接入最佳的网关机，因为为了使得连接的质量更高，选择最近负载最低的网关机获得收益<br/>
  2、对连接的管理，保证长连接被可靠的持有，连接断开能够快速重连，维护连接的基本路由信息，实现基本的上行/下行消息的收发功能，
以最小的内存占用为优化目标，使得单机可以存储更多的长连接，尽可能减少有状态服务重启对用户体验的影响 <br/>
  3、隔离 __变更频繁__ 的控制状态，心跳，重试，回执，路由等状态，尽可能的使用分布式内存，计算与存储分离，保证处理逻辑的平台迭代不会
影响线上功能
  4、下行小心下发时，减少网络调用次数，降低单聊下行消息的延迟，提高群聊下行小心的吞吐
    
#### 业务层：
* 应用层
  * 权限管理
  * 业务编排
  * 数据聚合
* 领域层
  * 用户管理
  * 消息管理
  * 会话管理
* 基础设施层
  * RPC Cache DB MQ ... 封装一些中间件
  * 基础公共库
  * mock server

 对于业务层来说，为了实现业务功能之外，为应对快读迭代的需求，其在设计上需要更多的考虑可维护性 <br/>
基于 经典的洋葱架构，我们可以简单的拆解为 应用层，领域层，基础设施层，对于复杂的业务可以设置 BBF服务 <br/>
  1、应用层，对于应用层来说，用来处理简单的面向业务需求的处理逻辑，比如 权限管理，业务规则，数据聚合等需求
  2、领域层，领域层用来沉淀业务无关可跨领域复用的共鞥你需求，提高核心业务价值，主要 分为 用户，会话，消息 三个部分，
    用户管理：主要获取 用户信息，用户的配置，生成用户ID 等功能 
    会话管理：用来分配会话ID 管理群聊以及 单聊的元信息，组内成员列表，加入群，退出群，禁言等对会话进行管理的功能，
    消息管理：以消息作为实体，控制消息的同步，存储，状态等变更控制行为
  3、基础设施层：基于依赖倒置原则，保证领域层不依赖任何基础设施，而是通过定义标准的适配接口屏蔽对基础设施库的依赖，在基础设施层用来封装
    MQ,redis,mysql,timeline, rpc, 服务发现等基础组件的时候，由于定义了适配接口实现了依赖倒置，基础设施层可以随意替换，而不用修改代码
    ，从业务角度看基础设施的代码虽然重要，但不是业务核心，可随时替换成最佳组件
  
#### 存储层：
* 数据库
* 缓存
* 序列号生成器
  * 在线消息同步
  * 离线消息同步
  * 历史消息同步

对于存储服务来说，大型互联网架构上，为方便数据复用，都会抽象出独立的数据服务，也更方便数据团队维护和迭代，通常可以叫做逻辑数据库，
面向业务抽象定制化存储模型，用来更加便捷的描述数据特征，对业务提供更灵活高校的数据存储服务

对于存储服务来说，可以划分为，普通结构化数据的存储，例如 用户信息，会话信息，对于计数数据，由于其巨量的写吞吐我们将其存储在特殊的专用
存储引擎上，并封装为 counter server, 更好的提供极大规模的计数服务，对于消息服务来说其挑战在于短时效消息的及时可靠的多端同步，
海量消息的存储与检索，因此抽象出专用的 timeline 模型，对业务层屏蔽细节，存储模型底层基于数据时效实现冷热数据分离存储，权衡高吞吐，低延迟，
高可靠，低成本等技术目标的综合效果最大化


## 消息状态机
> 状态机分析方法



## 存储设计
> 负载驱动

### KV 设计

序号生成： redis key = seq_id:{session_id}, value: int 64
离线消息： redis key = offline_msg:u{user_id} value:zset( sorce 为 seqID, number 为 message 的 pb )






























    